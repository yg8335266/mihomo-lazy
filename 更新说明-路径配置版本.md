# 更新说明 - 路径配置版本

## 🎯 更新背景

用户反馈在某些情况下运行脚本时，cmd.exe 的工作目录显示为 `C:\Windows\System32`，导致脚本无法找到 `mihomo.exe` 和 `config.yaml` 文件，服务启动失败。

这是 Windows 批处理脚本的常见问题，尤其在以下场景中：
- 通过快捷方式启动
- 右键菜单"发送到"启动
- 某些自动化工具调用
- 特定系统配置

## ✨ 本次更新内容

### 1️⃣ 新增文件

| 文件名 | 类型 | 说明 |
|--------|------|------|
| **启动脚本-路径模板.bat** | 批处理脚本 | 带路径占位符的启动脚本（有窗口） |
| **start-mihomo-路径配置版.vbs** | VBScript | 带路径占位符的 VBS 脚本（静默后台） |
| **路径配置说明.md** | 文档 | 详细的路径配置教程和 FAQ |
| **快速配置向导.txt** | 文档 | 简洁的一页式配置向导 |
| **更新说明-路径配置版本.md** | 文档 | 本文件，更新说明 |

### 2️⃣ 文件特性

#### 启动脚本-路径模板.bat
- ✅ 明确的路径配置区域，占位符标注清晰
- ✅ 完整的路径验证机制
- ✅ 详细的错误提示和诊断信息
- ✅ UTF-8 with BOM 编码，中文显示正常
- ✅ 支持任意目录运行，不依赖工作目录

#### start-mihomo-路径配置版.vbs
- ✅ VBScript 版本的路径配置脚本
- ✅ 静默后台启动，无窗口干扰
- ✅ 完整的文件存在性检查
- ✅ 友好的错误提示弹窗
- ✅ 适合日常使用和开机自启动

### 3️⃣ 配置示例

用户只需在脚本开头填写路径：

**BAT 脚本配置：**
```batch
REM Mihomo 安装目录（存放所有文件的文件夹）
set "MIHOMO_DIR=D:\Tools\mihomo-lazy"

REM mihomo.exe 可执行文件完整路径
set "MIHOMO_EXE=D:\Tools\mihomo-lazy\mihomo.exe"

REM config.yaml 配置文件完整路径
set "CONFIG_FILE=D:\Tools\mihomo-lazy\config.yaml"
```

**VBS 脚本配置：**
```vbscript
' Mihomo 安装目录（存放所有文件的文件夹）
mihomoDir = "D:\Tools\mihomo-lazy"

' mihomo.exe 可执行文件完整路径
mihomoExe = "D:\Tools\mihomo-lazy\mihomo.exe"
```

## 🔄 与原版脚本的对比

| 特性 | 原版脚本 | 路径配置版 |
|------|---------|-----------|
| 路径处理 | `%~dp0` 自动获取 | 手动配置绝对路径 |
| 灵活性 | 必须与文件同目录 | 可放置在任意位置 |
| 配置难度 | 无需配置 | 需要填写路径 |
| 适用场景 | 简单部署 | 复杂环境、路径问题 |
| 运行要求 | 脚本与文件同目录 | 只需配置正确路径 |
| 错误诊断 | 标准错误提示 | 详细的路径验证提示 |

## 📝 使用建议

### 🌟 推荐使用原版脚本的场景
- 所有文件在同一目录下
- 双击脚本可以正常运行
- 不需要特殊的路径配置

### 🌟 推荐使用路径配置版的场景
- 遇到"找不到文件"错误
- 运行路径显示为 `C:\Windows\System32`
- 需要从任意位置启动服务
- 需要明确控制所有文件路径
- 用于开机自启动或计划任务

## 🛠️ 快速开始

### 第一步：确定路径
打开文件资源管理器，找到你的 Mihomo 安装目录，复制完整路径。

例如：`D:\Tools\mihomo-lazy`

### 第二步：编辑脚本
1. 右键编辑 `启动脚本-路径模板.bat`（用 VS Code 或 Notepad++）
2. 在文件开头找到【路径配置区域】
3. 将占位符替换为实际路径
4. 保存文件

### 第三步：测试运行
双击 `启动脚本-路径模板.bat`，观察输出：
- 如果看到 ✓ 标记，说明配置正确
- 如果看到 ✗ 标记，根据提示检查路径

### 第四步：日常使用
配置完成后，可以使用 `start-mihomo-路径配置版.vbs` 进行静默启动。

## ⚙️ 技术细节

### 路径处理机制

**原版脚本：**
```batch
cd /d "%~dp0"
```
- `%~dp0` 获取批处理文件所在目录
- `cd /d` 切换到该目录
- 问题：在某些调用方式下，`%~dp0` 可能为空或不正确

**路径配置版：**
```batch
set "MIHOMO_DIR=D:\Tools\mihomo-lazy"
cd /d "%MIHOMO_DIR%"
```
- 使用显式的绝对路径
- 不依赖脚本所在位置
- 更可靠，更易于调试

### 文件验证流程

路径配置版增加了完整的文件验证：
1. ✅ 检查路径是否已配置（是否还是占位符）
2. ✅ 检查目录是否存在
3. ✅ 检查 mihomo.exe 是否存在
4. ✅ 检查 config.yaml 是否存在
5. ✅ 检查端口配置是否正确

每一步都有清晰的错误提示和建议。

## 📚 相关文档

- **详细配置教程**：[路径配置说明.md](路径配置说明.md)
- **快速配置指南**：[快速配置向导.txt](快速配置向导.txt)
- **主文档**：[README.md](README.md)
- **编码技术文档**：[ENCODING.md](ENCODING.md)

## ❓ 常见问题

### Q: 我应该使用哪个版本？

**A:** 
- 如果原版脚本能正常运行 → 继续使用原版
- 如果遇到路径问题 → 使用路径配置版
- 不确定 → 先尝试原版，有问题再换路径配置版

### Q: 路径中有空格怎么办？

**A:** 正常填写即可，脚本会自动处理。例如：
```batch
set "MIHOMO_DIR=D:\Program Files\mihomo-lazy"
```

### Q: 可以使用相对路径吗？

**A:** 不建议。路径配置版的设计目标就是使用绝对路径避免相对路径的不确定性。

### Q: 配置好后可以移动脚本位置吗？

**A:** 可以！因为使用了绝对路径，脚本可以放在任意位置（只要 mihomo.exe 等文件不移动）。

## 🔧 故障排查

### 问题：双击脚本后提示"路径尚未配置"

**原因**：占位符没有被替换

**解决**：
1. 用文本编辑器打开脚本
2. 找到包含 `【请填写：...】` 的行
3. 替换为实际路径
4. 保存后重试

### 问题：提示"无法切换到工作目录"

**原因**：配置的目录路径不存在或拼写错误

**解决**：
1. 检查路径是否正确（复制粘贴地址栏路径）
2. 确认目录确实存在
3. 注意路径大小写（虽然 Windows 不区分，但保持一致更好）

### 问题：提示"未找到 mihomo.exe"

**原因**：mihomo.exe 路径配置错误

**解决**：
1. 打开文件资源管理器
2. 找到 mihomo.exe 文件
3. 按住 Shift 键，右键点击文件
4. 选择"复制为路径"
5. 粘贴到脚本中（记得去掉外层引号）

## 📊 更新历史

**2024-11** - 路径配置版本发布
- 新增路径配置版批处理脚本
- 新增路径配置版 VBScript
- 新增配置文档和快速向导
- 更新 README 添加路径问题 FAQ

## 💡 反馈与建议

如果在使用中遇到问题或有改进建议，欢迎在 [Issues](https://github.com/hubentuan/mihomo-lazy/issues) 反馈！

---

**更新时间**：2024-11  
**适用版本**：mihomo-lazy v1.0+
