# Mihomo 路径配置说明

## 问题背景

当在 Windows 中双击运行 `.bat` 或 `.vbs` 脚本时，可能会遇到以下问题：

- **运行路径问题**：cmd.exe 的工作目录可能是 `C:\Windows\System32` 而不是脚本所在目录
- **相对路径失效**：导致脚本找不到 `mihomo.exe`、`config.yaml` 等文件
- **启动失败**：服务无法正常启动或出现各种错误

## 解决方案

我们提供了带有**明确路径配置**的新版本脚本，让你可以手动指定所有关键路径。

---

## 📁 新增文件

### 1. `启动脚本-路径模板.bat`
- **功能**：批处理版本的启动脚本（带窗口）
- **优势**：可以看到启动过程和日志输出
- **适合**：首次配置、调试问题

### 2. `start-mihomo-路径配置版.vbs`
- **功能**：VBScript 版本的启动脚本（静默后台）
- **优势**：双击后台运行，无窗口干扰
- **适合**：日常使用、开机自动启动

---

## 🛠️ 配置步骤

### 第一步：确定你的 Mihomo 安装路径

假设你的文件结构如下：
```
D:\Tools\mihomo-lazy\
├── mihomo.exe
├── config.yaml
├── 启动脚本-路径模板.bat
├── start-mihomo-路径配置版.vbs
└── ...
```

那么你的路径配置应该是：
- **安装目录**：`D:\Tools\mihomo-lazy`
- **mihomo.exe**：`D:\Tools\mihomo-lazy\mihomo.exe`
- **config.yaml**：`D:\Tools\mihomo-lazy\config.yaml`

---

### 第二步：配置 BAT 脚本

1. **右键编辑** `启动脚本-路径模板.bat`（使用记事本或 VS Code）

2. **找到路径配置区域**（文件开头）：
```batch
REM ════════════════════════════════════════════════════════════════
REM  【路径配置区域 - 请根据实际情况填写】
REM ════════════════════════════════════════════════════════════════

REM Mihomo 安装目录（存放所有文件的文件夹）
set "MIHOMO_DIR=【请填写：如 D:\Tools\mihomo-lazy】"

REM mihomo.exe 可执行文件完整路径
set "MIHOMO_EXE=【请填写：如 D:\Tools\mihomo-lazy\mihomo.exe】"

REM config.yaml 配置文件完整路径
set "CONFIG_FILE=【请填写：如 D:\Tools\mihomo-lazy\config.yaml】"
```

3. **替换占位符**为你的实际路径：
```batch
REM Mihomo 安装目录（存放所有文件的文件夹）
set "MIHOMO_DIR=D:\Tools\mihomo-lazy"

REM mihomo.exe 可执行文件完整路径
set "MIHOMO_EXE=D:\Tools\mihomo-lazy\mihomo.exe"

REM config.yaml 配置文件完整路径
set "CONFIG_FILE=D:\Tools\mihomo-lazy\config.yaml"
```

4. **保存文件**（确保使用 UTF-8 with BOM 编码）

---

### 第三步：配置 VBS 脚本

1. **右键编辑** `start-mihomo-路径配置版.vbs`（使用记事本或 VS Code）

2. **找到路径配置区域**（文件开头）：
```vbscript
' ════════════════════════════════════════════════════════════════
'  【路径配置区域 - 请根据实际情况填写】
' ════════════════════════════════════════════════════════════════

' Mihomo 安装目录（存放所有文件的文件夹）
mihomoDir = "【请填写：如 D:\Tools\mihomo-lazy】"

' mihomo.exe 可执行文件完整路径
mihomoExe = "【请填写：如 D:\Tools\mihomo-lazy\mihomo.exe】"

' config.yaml 配置文件完整路径（相对于 mihomoDir）
configFile = "config.yaml"
```

3. **替换占位符**为你的实际路径：
```vbscript
' Mihomo 安装目录（存放所有文件的文件夹）
mihomoDir = "D:\Tools\mihomo-lazy"

' mihomo.exe 可执行文件完整路径
mihomoExe = "D:\Tools\mihomo-lazy\mihomo.exe"

' config.yaml 配置文件完整路径（相对于 mihomoDir）
configFile = "config.yaml"
```

4. **保存文件**

---

## ✅ 测试与使用

### 首次测试

1. **双击运行** `启动脚本-路径模板.bat`
2. 观察输出信息，确认：
   - ✓ 工作目录正确
   - ✓ 文件检查通过
   - ✓ 端口读取成功
   - ✓ 进程启动成功

### 日常使用

- **方式 1（推荐）**：双击 `start-mihomo-路径配置版.vbs` 静默启动
- **方式 2**：双击 `启动脚本-路径模板.bat` 查看日志

---

## 🔍 常见问题

### Q1：路径中包含空格怎么办？

**答**：正常填写即可，脚本会自动处理。例如：
```batch
set "MIHOMO_DIR=D:\Program Files\mihomo-lazy"
```

### Q2：路径中包含中文怎么办？

**答**：可以正常使用中文路径，但建议避免（可能引发其他编码问题）。例如：
```batch
set "MIHOMO_DIR=D:\工具\mihomo-lazy"
```

### Q3：如何确认路径填写正确？

**答**：在 cmd 中测试：
```cmd
cd /d D:\Tools\mihomo-lazy
dir mihomo.exe
dir config.yaml
```
如果能看到文件列表，说明路径正确。

### Q4：双击脚本后提示"路径尚未配置"？

**答**：说明你没有修改占位符。请按照上述步骤编辑脚本，将 `【请填写：...】` 替换为实际路径。

### Q5：还是无法运行？

**答**：按以下步骤排查：

1. **检查文件编码**（.bat 文件）：
   ```bash
   # 确保是 UTF-8 with BOM
   head -c 3 "启动脚本-路径模板.bat" | od -An -tx1
   # 应该显示：ef bb bf
   ```

2. **手动测试启动命令**：
   ```cmd
   cd /d D:\Tools\mihomo-lazy
   mihomo.exe -d . -f config.yaml
   ```

3. **以管理员身份运行**：
   右键脚本 → "以管理员身份运行"

---

## 📚 与原版脚本的区别

| 特性 | 原版脚本 | 路径配置版 |
|------|---------|-----------|
| 路径处理 | 使用 `%~dp0` 自动获取 | 手动配置绝对路径 |
| 灵活性 | 必须与脚本同目录 | 可放置在任意位置 |
| 适用场景 | 简单部署 | 复杂环境、调试 |
| 运行要求 | 脚本与文件同目录 | 只需配置正确路径 |

---

## 💡 推荐使用方式

### 场景 1：简单部署（所有文件在同一目录）
- **推荐**：使用原版脚本（`start-mihomo.vbs`、`首次安装.bat`）
- **原因**：自动处理路径，开箱即用

### 场景 2：遇到路径问题 / 特殊部署
- **推荐**：使用路径配置版（本文档介绍的脚本）
- **原因**：明确控制所有路径，避免工作目录问题

### 场景 3：开机自启动
- **推荐**：配置完成后，使用 `开启开机启动.bat` 将 VBS 脚本添加到启动项
- **注意**：如果使用路径配置版，记得先配置好路径

---

## 🔧 技术说明

### 为什么需要配置路径？

Windows 批处理和 VBScript 的工作目录机制：

1. **双击运行**：工作目录 = 脚本所在目录（理想情况）
2. **快捷方式运行**：工作目录 = 快捷方式设置的目录
3. **右键 → 发送到**：工作目录 = 用户主目录
4. **命令行运行**：工作目录 = 当前 cmd 所在目录

**问题**：在某些情况下，工作目录可能变成 `C:\Windows\System32`，导致相对路径失效。

**解决**：使用绝对路径，明确指定所有文件位置。

---

## 📞 反馈与支持

如果遇到问题，请提供以下信息：

1. Windows 版本
2. Mihomo 文件所在目录
3. 双击脚本后的错误提示截图
4. 配置的路径内容

---

**最后更新**：2024-11
